* TODO Epic: Scale the first NixOS "Learning cliff"
** DONE [#A] pidrive nixos bootstrap
   CLOSED: [2021-02-07 Sun 20:03]
*** DONE [#A] Figure out why ssh pinentry fails to show
    CLOSED: [2021-02-07 Sun 20:04]
**** It is on the tty behind sway. This is annoying.
     I figured it out!!!
     What works:
     * systemctl --user restart gpg-agent
     * gpg-connect-agent updatestartuptty /bye
     Maybe it's not showing graphically because it doesn't have the env vars
     `systemctl --user show-environmenty`
     
    [[https://wiki.archlinux.org/index.php/environment_variables][Environment variables - ArchWiki]] 
    [[https://wiki.archlinux.org/index.php/Systemd/User#Environment_variables][systemd/User - ArchWiki]] 
   [[https://wiki.gnome.org/Initiatives/Wayland/SessionStart][Initiatives/Wayland/SessionStart - GNOME Wiki!]] 
** DONE SSH agent forwarding
   CLOSED: [2021-02-09 Tue 12:02]
   So I can git clone, ssh out, etc
   Is there some nice way to handle key distribution? I think this is a problem for another year.
** TODO Flakes
*** DONE flakes-enabled nix
    CLOSED: [2021-02-06 Sat 21:02]
   https://www.tweag.io/blog/2020-07-31-nixos-flakes/
*** DONE Add flake.nix for pidrive
    CLOSED: [2021-02-09 Tue 11:39]
*** DONE Single top-level flake with multiple outputs
    CLOSED: [2021-02-09 Tue 20:02]
*** DONE Decide how to deal with generated hardware-config.nix? Commit it.
    CLOSED: [2021-02-18 Thu 11:32]
*** DONE Figure out how to bootstrap hostname with flake.nix
    CLOSED: [2021-02-18 Thu 11:32]
    nixos-rebuild test --flake #pidrive
    is there any way to set hostname based on nixosSystem key?
    need to enable flakes anyway so running manually with 
        NIXOS_CONFIG=machines/name/configuration.nix nixos-rebuild switch
    but this doesn't pin package versions   
**** Bootstrap VPS: publicist
**** Wordpress site on publicist
*** TODO Replace nixpkgs channels with flakes
* TODO Epic: Network Foundation
** TODO Decide how to deploy secrets
   - what does the community do (davidak etc)?
   - Password store integration?
   - git-crypt
   - https://christine.website/blog/nixos-encrypted-secrets-2021-01-20
   - https://github.com/mozilla/sops ([[https://github.com/colemickens/nixcfg#secrets][colemickens uses]])
   - https://github.com/Mic92/sops-nix
   - https://www.reddit.com/r/NixOS/comments/j6nqbe/declarative_secrets/
   https://discourse.nixos.org/t/how-to-setup-user-ssh-keys/5745/6
** TODO Configure all nodes as part of a Wireguard network
* TODO Hardware basics
** TODO capslock is escape, switch left alt and left meta
** Hard drive
** Power management
   https://discourse.nixos.org/t/fan-keeps-spinning-with-a-base-installation-of-nixos/1394/3?u=edrex
** Bluetooth
** Wifi
* TODO Epic: Backups
** TODO Syncthing?
* TODO Epic: armv7
** TODO [#A] bootstrap cobaltsoul
   https://nixos.wiki/wiki/NixOS_on_ARM/ODROID-HC1
   Let's try with unstable kernel, maybe the same uboot patches that helped the pi3 will help.
* TODO M3: prove out my shell env
** TODO Bootstrap a test VM on chip
** TODO homemanager
   - sway
   - spacemacs
** TODO sway stuff
   use colemickens' overlay prob
   - waybar
   - wofi
   - wlr-randr
   - kanshi
** TODO Sway config
   - use the wayland overlay
   - look at op configs (cole?)
   https://nixos.wiki/wiki/Sway
   https://github.com/colemickens/nixpkgs-wayland
** TODO home-manager
   https://github.com/nix-community/home-manager 
** Emacs
*** WAITING nativecomp
    [gccemacs packaging · Issue #87400 · NixOS/nixpkgs](https://github.com/NixOS/nixpkgs/issues/87400)
*** TODO doom-emacs
    https://github.com/vlaci/nix-doom-emacs
    https://github.com/hlissner/doom-emacs 
    https://github.com/hlissner/doom-emacs/blob/develop/docs/faq.org
    https://github.com/hlissner/doom-emacs/blob/develop/modules/config/default/+evil-bindings.el
*** org agenda / refile and projectile
    [[https://shreyas.ragavan.co/post/8f702ce2-8bb7-40a3-b44b-a47222c02909/][Juggling multiple projects and leveraging org-projectile | Shreyas Ragavan]]
    https://develop.spacemacs.org/layers/+emacs/org/README.html#project-support
* GPG/SSH Agent
  https://github.com/colemickens/nixcfg/blob/main/mixins/gpg-agent.nix


  
* Features
** TODO [#A] New wordpress host for Lauren
** TODO [#B] cobaltsoul Mac OS backup target
   Research: Time machine or something else? 
   Seems time machine bug "error 92" is fixed, so let's keep using time machine (over NFS)
* Profiles
** Desktop
*** TODO Blueman
* Machines
** DONE pidrive
   CLOSED: [2021-02-11 Thu 15:11]
** silversurfer
*** DONE Look up model info
    [[https://techable.com/apple/specs/macbook-pro-core-2-duo-2-16-ghz-15-inch-late-2006/][MacBook Pro | Core 2 Duo 2.16 GHz | 15 Inch | Late 2006 - Techable.com]] 
    | Apple Model Number | A1211 (EMC 2120) |
    | Model ID           | MacBook Pro 2.2  |
    [[https://www.ifixit.com/Device/MacBook_Pro_15%22_Core_2_Duo_Model_A1211][MacBook Pro 15" Core 2 Duo Model A1211 - iFixit]] 
    https://en.wikipedia.org/wiki/Radeon_X1000_series
    http://www.vgamuseum.info/index.php/cpu/item/640-ati-radeon-x1600-xt
    01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV530/M56-P [Mobility Radeon X1600]
        Subsystem: Apple Inc. MacBook Pro
        Kernel modules: radeon
*** TODO fix modeset issue
    Best summary of steps needed:
     - [[https://bbs.archlinux.org/viewtopic.php?pid=1810437#p1810437][Load custom Radeon firmware for Macbook Pro / Kernel & Hardware / Arch Linux ...]] 
     - http://www.andreasbaumann.cc/blog/archlinux-macbook-a1211/
     
     Also:
     [[https://forum.artixlinux.org/index.php/topic,586.0.html][{SOLVED} 32bit Mac EFI doesn't expose vbios in UEFI mode]] 
     [[https://bugs.freedesktop.org/show_bug.cgi?id=26891#c3][26891 – Radeon KMS fails with inaccessible AtomBIOS on systems with (U)EFI boot]]  
*** TODO Bless EFI partition with macos installer disk
    [[https://mattgadient.com/reducing-the-30-second-delay-when-starting-64-bit-ubuntu-in-bios-mode-on-the-old-32-bit-efi-macs/][Reducing the 30 second delay when starting 64-bit Ubuntu in BIOS mode on the ...]] 
*** 
*** DONE Research issue with 64bit
    Issue is 32bit EFI with 64bit OS
*** DONE Make 32bit min usb
    CLOSED: [2021-02-11 Thu 19:27]
    https://nixos.org/manual/nixos/stable/index.html#sec-booting-from-usb
    [[https://www.acronis.com/en-us/articles/usb-boot/#:~:text=Insert%20the%20USB%20boot%20media,to%20OS%20X's%20Startup%20Manager.][How to Boot from USB on Mac]] 
*** DONE Backup old homedir before format
    CLOSED: [2021-02-17 Wed 22:43]
**** Formatted backup drive ZFS!
**** Having deadlock copying homedir to USB drive
     Not sure if src hw, dest hw, or ZFS bug.
     Maybe [[https://github.com/openzfs/zfs/issues/11527][openzfs/zfs#11527 Deadlock or missed wakeup with heavy I/O, file deletion, an...]] 
     Wow, deadlock bugs in FS, adventure!
**** So falling back to backing up root partition using [[https://github.com/openzfs/zfs/issues/11527][ddrescue]]
       (included in NixOS min installed, yay!)
     seems to be working so far.
*** DONE Format drive
    CLOSED: [2021-02-17 Wed 22:43]
    btrfs because zfs has issues..
    [[https://gist.github.com/samdroid-apps/3723d30953af5e1d68d4ad5327e624c0][nixos install (boot + btrfs)]] 
*** DONE Install 32bit
    CLOSED: [2021-02-17 Wed 22:43]
*** DONE Make 64bit usb
    CLOSED: [2021-02-17 Wed 22:43]
*** DONE Install 64bit
    CLOSED: [2021-02-17 Wed 22:43]
*** DONE MEH Have latest UEFI fw?
    Check in kernel?
    [[https://support.apple.com/kb/DL204?locale=en_US][Firmware Restoration CD 1.4]]
    [[https://support.apple.com/en-us/HT201518][About EFI and SMC firmware updates for Intel-based Mac computers - Apple Support]] 
    https://apple.stackexchange.com/questions/311947/how-to-update-latest-macbook-pro-efi-firmware-manually 
    
*** DONE set nomodeset in grub
    CLOSED: [2021-02-17 Wed 23:14]
*** DONE Bootstrap nixos-config
    CLOSED: [2021-02-18 Thu 02:40]
    ssh copy, add a new flake output, and run it
*** OT: interesting, later OSX releases:
    http://forum.netkas.org/index.php?topic=7505.0
*** TODO ? Add to https://github.com/NixOS/nixos-hardware/tree/master/apple/macbook-pro

** TODO chip
** DEFERRED coboltsoul and bookmobile (armv7 builds are a lot more work)
   Waiting on:
   - Get some experience setting up easier systems
   - Get TTL-USB cable

   
   patagonicus shared his build config: https://cloud.breab.org/index.php/s/N3HGqzCeMcitLgB
   he says he bisected and found this commit breaks boot: https://github.com/NixOS/nixpkgs/commit/9c213398b312e0f0bb9cdf05090fd20223a82ad0
   :CHATLOG:
patagonicus
Hi. I managed to build and test a modified multiplatform image: http://cloud.breab.org/index.php/s/N3HGqzCeMcitLgB
Just uncompress, write to a MicroSD card, then add the bootloader on top based on the commands on the wiki. It should get an address via DHCP and allow login over SSH with nixos/nixos
I'm also trying to make an export of the full system from the nix store including the build deps so you can change stuff without having to recompile everything, but that will be … a bit bigger. And currently it's complaining about "file too large" and I don't really know why.
Ok, works, mostly, only small problem is that there's no git on the image, so you'll have to git clone from the bare repo on another machine and then copy that over so you can use that nixpkgs for building stuff - like git.
edrex
people are posting their cachix keys on the NixOS_on_Arm wiki page, but without package listings it seems pretty useless. Would it be a ton of work to set up a little armv7 hydra for a subset of packages? Use flakes to build images with exact nixpkgs etc?
Where I'm at in learning / deploying nixos rn: https://github.com/edrex/nixos-config
patagonicus
I think the main problems are that there's no one that wants to maintain armv7l build machines + fixing problems and that there aren't many good machines running armv7 that you can put in a data center.
So, in the link I gave above there's the minimal config I used to build the system. I also need to move my fixes that I have on top of nixpkgs out of the repo and instead into an overlay, which would make stuff a lot nicer - then I can also just reference a specific commit in the config and have nix pull it automatically.
edrex
Should be able to run armv7 containers/vms on an aarch64 host os
patagonicus
I think there's still a small difference, but I don't exactly remember.
I'm willing to throw money at nixos for armv7l support, but there doesn't seem to be a way for that. :D
edrex
ok, IDK if i'll be able to dig into this today because I have some outdoor chores to do before big snow/coldsnap hits west coast.
I'm going to take the hc1 i have here with me, so I can keep tinkering with it.
patagonicus
No worries. There's more people running armv7l in the chat room and I think one or two with HC1/2s as well.
edrex
I'll have a look. It would be awesome if we could find a sane/sustainable/sharable way to share package builds going forward
patagonicus
Yeah. Someone was recently talking on #nixos-chat about setting up a community cache. I've considered making my stuff available, but as you said, it only works if everyone uses the same nixpkgs and similar configs.
edrex
thanks so much for engaging with me :) i will try to be a net positive
patagonicus
:D
I'm always happy to help. And I would have never gotten my machines running without people from the chat room.
edrex
flakes seem like a big step forward in making that easier, right? we can all just pin nixpkgs for our base system in system flake? and then vary it per-input if we need something newer?
alright, i'll let you get offline :D
patagonicus
I've never really looked into flakes, but I've manually pinned nixpkgs before, it's not complicated. So we could have a common file you import that specifies nixpkgs and a few settings.
   :END:
   :CHATLOG:
edrex (@edrex:matrix.org)
patagonicus heey, i'm just about to attempt nixos install on an odroid hc1. Last time I tried (a few months back, following your instructions on the wiki), it wouldn't boot (and I don't have a TTL-USB cable to look at the UART rn). So if you're still around I might HYU with Qs..
patagonicus
edrex: sure, I can help with that. I also woke up like 15mins ago, so I might not give the best advice for the next hour or so. :D
edrex (@edrex:matrix.org)
:D
patagonicus
The main problem I can see is that nixpkgs often doesn't compile on armv7l. I've already spent a week going from early December to something more recent and it doesn't work. And my current problem is that it doesn't boot …
I think my recommendation would be to use nixpkgs at 26cc536edf2 and to cherry-pick b70430a3ddf8f9153606c4e5aa8034cf361c709b on top of that. That is roughly what I'm currently running on my HC2s.
And I still haven't documented how to make the HDDs properly shut down when you reboot/power off …
edrex (@edrex:matrix.org)
i am just tackling the first NixOS learning cliff this week, so I only 2/3 understand what you're talking about with nixpkgs. Do you mean a week compiling on device?
they keep spinning when you halt the system?
so you have an HC1 that currently doesn't boot and HC2s that work? You use the HC1 to test configs first?
i have 2 HC1s
patagonicus
Well, compiling, failing, then changing something and compiling again. Building my system on my devices takes about 24h or a bit less. I have four HC2s with distributed compiling, but a lot of the compile time comes from packages that are needed for all later packages, so I'm actually not sure how much faster it is compared to a single machine.
I don't have any HC1s, but AFAIK the only difference is the metal they are mounted on, exactly the same board for the electronics.
And they all boot, just not if I try to switch to a newer version of nixpkgs.
For the HDDs it's a known problem that they don't automatically spin them down: https://wiki.odroid.com/odroid-xu4/troubleshooting/shutdown_script

odroid-xu4:troubleshooting:shutdown_script [ODROID Wiki]
You are here odroid-xu4 troubleshooting shutdown_script Trace shutdown_script odroid-xu4:troubleshooting:shutdown_script Show pagesource
edrex (@edrex:matrix.org)
don't the HC2s run on 12V power?
patagonicus
I've codified that into my configuration.nix
Ah, yes. Ok, then they are different, I guess. But that shouldn't matter for nix.
edrex (@edrex:matrix.org)
thanks! Adding to my notes
but yeah, my impression that other than the drive power they are identical
patagonicus
You are probably crosscompiling currently, right? Or are you building on the HC1 from a different Linux? As long as you find something to install Nix on it should work.
Just note that it will take a decent amount of disk space (I wouldn't try it on a MicroSD card smaller than 32GB unless you put /nix on the HDD/SSD) and you'll need at least a few gigs of swap space.
edrex (@edrex:matrix.org)
IDK yet. still figuring stuff out
What about native compiling under QEMU on a fast amd64?
patagonicus
Hmm, good question. It's probably slower than cross-compiling on the same machine, but on the other hand it would not be cross-compiling, so it would save you the trouble of having to recompile everything on the machine once you have it booted up and want to change the system.
I haven't tried. I managed to bootstrap by cross compiling and since then only compiled natively on NixOS.
edrex (@edrex:matrix.org)
I may not have the nix chops yet to execute this successfully. I was hoping to get it bootstrapped to the point where I can continue remotely over SSH (i leave arm NASes at my friends' houses like Johnny Homeserver-seed, and I'm only here till tomorrow eve)
patagonicus
Oh, that's a bit short as compiling everything takes a while. I could see if I can build you an SD card image to get it booted up, but you'd still have to configure afterwards.
edrex (@edrex:matrix.org)
I'll give it a go and see if it boots at least :D
thanks
patagonicus
And, yeah, I don't really trust the machines yet to run them without physical access, but I'm considering wiring up UART in a loop and getting some "smart" power plugs so I can power cycle them. It's unlikely to break so bad I can't just boot an older NixOS generation, so that should get me out of most problems.
edrex (@edrex:matrix.org)
Did you resolve the "no SATA on reboot" issue mentioned on the wiki? Debian wiki says a firmware flash might fix it
https://wiki.debian.org/InstallingDebianOn/OdroidHC1

InstallingDebianOn/OdroidHC1 - Debian Wiki
How to install Debian/Linux on a Odroid HC1
Yeah, I spent some time researching different auto-rollback options on different embedded linuxes a couple months ago. It would be cool if nixos knew how to roll back to the last successful boot if it didn't come all the way up to network. There are some issues discussing it.
Watchdog timer
patagonicus
Ah. The fix for that is to use the Hardkernel fork of the kernel, it's in nixpkgs, although not quite the newest version. But maybe it works in mainline by now? Haven't tried in a while.
edrex (@edrex:matrix.org)
i was hoping to get mainline working. but maybe that's too much
patagonicus
Ok, I managed to slightly modify the multiplatform sd image from nixpkgs to not require a ton of (re)builds, but it'll still take a bit to build.
Yesterday
clever
,stty
{^_^}
echo "stty rows $(tput lines) cols $(tput cols)"
patagonicus
Oh, no. I'm almost done with bisecting and I don't see anything in the remaining commits that should affecting booting at all. :(
Wait. Could it be a uboot/kernel mismatch? Maybe because of dtbs or something? But I'm pretty sure I tried a fully clean install on the version that didn't work and that didn't help.
patagonicus
Oof. I think I've been holding nix-build-status wrong. -_-
patagonicus
Yay, found it: https://github.com/NixOS/nixpkgs/commit/9c213398b312e0f0bb9cdf05090fd20223a82ad0 Makes more sense now, since that one is changing stuff related to the kernel. Now I have something to diff. :)

lib: Clean up how linux and gcc config is specified · NixOS/nixpkgs@9c21339 - GitHub
Second attempt of 8929989614589ee3acd070a6409b2b9700c92d65; see that commit for details. This reverts commit 0bc275e63423456d6deb650e146120c39c1e0723.
red[evilred]
oh wow, 5.6k messages since I've looked at this channel
it's been a while apparently :-(
edrex (@edrex:matrix.org)
[patagonicus](https://matrix.to/#/@freenode_patagonicus:matrix.org): that's the commit that broke boot for you? great sluething!
patagonicus
edrex: I just had to bisect a few ten thousand commits. :D
It seems to lose the hostPlatform extraConfig, although I don't understand why. The hostPlatform extraConfig for armv7 has one markerd as "Odroid XU4 hangs without this" and I'm using Odroid HC2s, which are almost identical …
edrex (@edrex:matrix.org)
what was your test procedure for each commit? fully generate an image, flash, try to boot?
patagonicus
Yes, unfortunately.
I'm not sure why I couldn't reproduce it by just replacing the kernel.
I did minimize the image a bit, but it still took forever to build - building just the kernel would have been … a bit faster.
   :END:
*** u-boot 
    https://github.com/NixOS/nixpkgs/blob/master/pkgs/tools/misc/odroid-xu3-bootloader/default.nix
    Mainline might work with a firmware update, see: https://wiki.debian.org/InstallingDebianOn/OdroidHC1
    https://wiki.odroid.com/odroid-xu4/software/jms578_fw_update
*** TODO cross compiling with qemu
    https://landley.net/aboriginal/presentation.html

    https://nixos.wiki/wiki/User:Samueldr/NixOS_on_ARM
* Services
* Network
** TODO Wireguard
*** Nixos and others interop.. how to exchange keys? Shared secret store?
** TODO Monitoring
   https://www.reddit.com/r/NixOS/comments/l84udd/what_do_you_use_for_monitoring/
   https://christine.website/blog/prometheus-grafana-loki-nixos-2020-11-20
   https://github.com/NixOS/nixpkgs/tree/master/nixos/modules/services/monitoring
** Alerts
*** TODO Basic
*** TODO Services down (mutual watch)
* Storage
** What to format drives with?
*** Would like to use ZFS for everything
    - openzfs is available for both [[https://openzfsonosx.org/][OS X]] and [[https://openzfsonwindows.org/][Windows]]
    - well-supported in NixOS https://nixos.wiki/wiki/NixOS_on_ZFS
    - Memory usage tho.
    However, It's unsafe to suspend with zfs:
      https://github.com/NixOS/nixpkgs/issues/106093
    https://blog.programster.org/zfs-cheatsheet
*** Portable (usb) drives
*** btrfs
    - Not portable (no macos impl currently)